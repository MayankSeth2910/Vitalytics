<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COPD Assessment - VITALYTICS</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --primary: hsl(187, 72%, 35%);
    --primary-light: hsl(187, 72%, 45%);
    --primary-glow: hsl(187, 80%, 60%);
    --bg: hsl(200, 20%, 98%);
    --card: hsl(0, 0%, 100%);
    --text: hsl(210, 20%, 15%);
    --text-muted: hsl(210, 10%, 45%);
    --border: hsl(210, 15%, 90%);
    --destructive: hsl(0, 72%, 51%);
    --success: hsl(142, 60%, 40%);
    --warning: hsl(38, 92%, 50%);
    --radius: 12px;
    --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.04);
    --shadow-lg: 0 4px 20px rgba(0,0,0,0.08);
  }

  body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
  a { text-decoration: none; color: inherit; }

  /* Navbar */
  .navbar { position: sticky; top: 0; z-index: 100; background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); }
  .navbar .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; display: flex; align-items: center; justify-content: space-between; height: 64px; }
  .logo { font-size: 1.4rem; font-weight: 700; color: var(--primary); letter-spacing: -0.5px; }
  .logo span { color: var(--text); }
  .nav-links { display: flex; gap: 2rem; list-style: none; }
  .nav-links a { font-size: 0.9rem; font-weight: 500; color: var(--text-muted); transition: color 0.2s; }
  .nav-links a:hover, .nav-links a.active { color: var(--primary); }
  .menu-btn { display: none; background: none; border: none; cursor: pointer; }
  .menu-btn svg { width: 24px; height: 24px; stroke: var(--text); }

  @media (max-width: 768px) {
    .nav-links { display: none; position: absolute; top: 64px; left: 0; right: 0; flex-direction: column; background: var(--card); border-bottom: 1px solid var(--border); padding: 1rem 1.5rem; gap: 1rem; box-shadow: var(--shadow-lg); }
    .nav-links.open { display: flex; }
    .menu-btn { display: block; }
  }

  /* Hero */
  .hero { background: linear-gradient(135deg, hsl(187,72%,95%), hsl(187,72%,90%)); border-bottom: 1px solid var(--border); padding: 3rem 1.5rem; text-align: center; }
  .hero h1 { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
  .hero p { color: var(--text-muted); max-width: 600px; margin: 0 auto; }

  /* Form */
  .form-section { max-width: 900px; margin: 2rem auto; padding: 0 1.5rem; }
  .form-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem 2rem; margin-bottom: 1.5rem; box-shadow: var(--shadow); opacity: 0; transform: translateY(20px); animation: fadeUp 0.5s ease forwards; }
  .form-card:nth-child(2) { animation-delay: 0.1s; }
  .form-card:nth-child(3) { animation-delay: 0.2s; }
  .form-card:nth-child(4) { animation-delay: 0.3s; }
  .form-card:nth-child(5) { animation-delay: 0.4s; }

  @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

  .section-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; }
  .section-icon { width: 40px; height: 40px; border-radius: 10px; background: hsl(187,72%,92%); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
  .section-header h2 { font-size: 1.15rem; font-weight: 600; }

  .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.25rem; }
  .form-group { display: flex; flex-direction: column; gap: 0.35rem; }
  .form-group label { font-size: 0.85rem; font-weight: 600; color: var(--text); }
  .form-group label .req { color: var(--destructive); }
  .form-group .desc { font-size: 0.75rem; color: var(--text-muted); }

  .form-group input, .form-group select {
    height: 40px; border: 1px solid var(--border); border-radius: 8px; padding: 0 0.75rem;
    font-size: 0.9rem; background: var(--bg); color: var(--text); outline: none; transition: border-color 0.2s, box-shadow 0.2s;
  }
  .form-group input:focus, .form-group select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px hsl(187,72%,35%,0.12); }
  .form-group.error input, .form-group.error select { border-color: var(--destructive); }
  .form-group .error-msg { font-size: 0.75rem; color: var(--destructive); min-height: 1em; }

  /* Disclaimer */
  .disclaimer { display: flex; gap: 0.75rem; align-items: flex-start; background: hsl(210,15%,96%); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem 1.25rem; margin-bottom: 1.5rem; }
  .disclaimer svg { flex-shrink: 0; width: 20px; height: 20px; stroke: var(--text-muted); margin-top: 2px; }
  .disclaimer p { font-size: 0.85rem; color: var(--text-muted); }

  /* Submit */
  .submit-wrap { text-align: center; margin-bottom: 2rem; }
  .btn-primary {
    display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 3rem;
    background: var(--primary); color: #fff; border: none; border-radius: 8px;
    font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s, box-shadow 0.2s;
    box-shadow: 0 0 20px hsl(187,72%,35%,0.3);
  }
  .btn-primary:hover { background: var(--primary-light); box-shadow: 0 0 30px hsl(187,72%,35%,0.45); }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
  .btn-primary .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Severity badge colours */
  .sev-mild    { background: hsl(142,60%,97%); border-color: hsl(142,60%,40%) !important; color: hsl(142,60%,30%); }
  .sev-moderate{ background: hsl(38,92%,97%);  border-color: hsl(38,92%,50%)  !important; color: hsl(38,92%,30%); }
  .sev-severe  { background: hsl(0,72%,97%);   border-color: var(--destructive) !important; color: var(--destructive); }
  .sev-very-severe { background: hsl(0,72%,95%); border-color: var(--destructive) !important; color: hsl(0,72%,38%); }

  /* Inline result panel */
  #result-panel { display:none; margin-top:1.5rem; animation: fadeUp 0.4s ease; }

  .result-badge-box {
    border-radius: 10px; padding: 1.5rem; text-align: center; border: 2px solid #ccc; margin-bottom: 1.5rem;
  }
  .result-label { font-size: .75rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); margin-bottom: .4rem; }
  .result-value { font-size: 2.2rem; font-weight: 700; }
  .conf-wrap { margin-top: .8rem; max-width: 300px; margin-left: auto; margin-right: auto; }
  .conf-text { font-size: .8rem; color: var(--text-muted); margin-bottom: .4rem; }
  .conf-track { height: 8px; background: rgba(0,0,0,.08); border-radius: 4px; overflow: hidden; }
  .conf-fill  { height: 100%; width: 0%; border-radius: 4px; transition: width 1s ease; background: var(--primary); }

  /* Detail table */
  .detail-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  .detail-table th, .detail-table td { padding: 0.6rem 1rem; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.875rem; }
  .detail-table th { background: var(--bg); font-weight: 600; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
  .detail-table tr:last-child td { border-bottom: none; }
  .detail-table td:last-child { font-weight: 600; }
  .flag { color: var(--destructive); font-size: 0.7rem; margin-left: 4px; }

  /* Obs / Rec lists */
  .obs-list { list-style: none; margin-top: 1rem; }
  .obs-list li { padding: .5rem 0 .5rem 1.5rem; position: relative; font-size: .9rem; color: var(--text-muted); }
  .obs-list li::before { content: '‚ö†'; position: absolute; left: 0; }
  .rec-list { list-style: none; margin-top: 1rem; }
  .rec-list li { padding: .5rem 0 .5rem 1.5rem; position: relative; font-size: .9rem; color: var(--text-muted); }
  .rec-list li::before { content: '‚úì'; position: absolute; left: 0; color: var(--success); font-weight: 700; }
  .sub-heading { font-size: 1rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: .25rem; }

  /* Footer */
  .footer { background: var(--text); color: hsl(210,10%,70%); padding: 2rem 1.5rem; text-align: center; font-size: .8rem; }
  .footer a { color: var(--primary-glow); }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
  <div class="container">
    <a href="index.html" class="logo">Vital<span>ytics</span></a>
    <ul class="nav-links" id="navLinks">
      <li><a href="index.html">Home</a></li>
      <li><a href="assesment.html" class="active">Assessment</a></li>
      <li><a href="descript.html">How It Works</a></li>
    </ul>
    <button class="menu-btn" id="menuBtn" aria-label="Toggle menu">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
  </div>
</nav>

<!-- Hero -->
<section class="hero">
  <h1>ü´Å COPD Severity Assessment</h1>
  <p>Enter pulmonary function and clinical data to predict COPD severity. Fields marked with <span style="color:var(--destructive)">*</span> are required.</p>
</section>

<!-- Form -->
<div class="form-section">
  <form id="copdForm" novalidate>

    <!-- Demographics -->
    <div class="form-card">
      <div class="section-header">
        <div class="section-icon">üë§</div>
        <h2>Patient Demographics</h2>
      </div>
      <div class="form-grid">
        <div class="form-group" data-field="age">
          <label>Age <span class="req">*</span></label>
          <input type="number" id="age" placeholder="e.g., 65" min="1" max="120" step="1">
          <span class="error-msg"></span>
        </div>
        <div class="form-group" data-field="gender">
          <label>Gender <span class="req">*</span></label>
          <select id="gender">
            <option value="">Select gender</option>
            <option value="0">Female</option>
            <option value="1">Male</option>
          </select>
          <span class="error-msg"></span>
        </div>
        <div class="form-group" data-field="pack_history">
          <label>Smoking Pack History (pack-years) <span class="req">*</span></label>
          <input type="number" id="pack_history" placeholder="e.g., 30" step="0.1" min="0">
          <span class="desc">Packs per day √ó years smoked</span>
          <span class="error-msg"></span>
        </div>
        <div class="form-group" data-field="age_quartiles">
          <label>Age Quartile <span class="req">*</span></label>
          <select id="age_quartiles">
            <option value="">Select quartile</option>
            <option value="1">Q1 (youngest)</option>
            <option value="2">Q2</option>
            <option value="3">Q3</option>
            <option value="4">Q4 (oldest)</option>
          </select>
          <span class="error-msg"></span>
        </div>
      </div>
    </div>

    <!-- Pulmonary Function -->
    <div class="form-card">
      <div class="section-header">
        <div class="section-icon">ü´Å</div>
        <h2>Pulmonary Function Tests</h2>
      </div>
      <div class="form-grid">
        <div class="form-group" data-field="mwt1">
          <label>1st 6-Min Walk (MWT1, metres) <span class="req">*</span></label>
          <input type="number" id="mwt1" placeholder="e.g., 370" step="1" min="0">
          <span class="desc">First attempt of the walk test</span>
          <span class="error-msg"></span>
        </div>
        <div class="form-group" data-field="mwt2">
          <label>2nd 6-Min Walk (MWT2, metres) <span class="req">*</span></label>
          <input type="number" id="mwt2" placeholder="e.g., 380" step="1" min="0">
          <span class="desc">Second attempt of the walk test</span>
          <span class="error-msg"></span>
        </div>
        <div class="form-group" data-field="mwt1best">
          <label>Best 6-Min Walk (MWT1Best, metres) <span class="req">*</span></label>
          <input type="number" id="mwt1best" placeholder="e.g., 380" step="1" min="0">
          <span class="desc">Normal: ‚â• 400 m</span>
          <span class="error-msg"></span>
        </div>
        <div class="form-group" data-field="fev1">
          <label>FEV1 (L) <span class="req">*</span></label>
          <input type="number" id="fev1" placeholder="e.g., 1.8" step="0.01" min="0">
          <span class="desc">Forced Expiratory Volume in 1 sec</span>
          <span class="error-msg"></span>
        </div>
        <div class="form-group" data-field="fev1pred">
          <label>FEV1 % Predicted <span class="req">*</span></label>
          <input type="number" id="fev1pred" placeholder="e.g., 62" step="0.1" min="0" max="200">
          <span class="desc">GOLD: Mild ‚â•80%, Mod 50‚Äì79%, Severe 30‚Äì49%, Very Severe &lt;30%</span>
          <span class="error-msg"></span>
        </div>
        <div class="form-group" data-field="fvc">
          <label>FVC (L) <span class="req">*</span></label>
          <input type="number" id="fvc" placeholder="e.g., 3.2" step="0.01" min="0">
          <span class="desc">Forced Vital Capacity</span>
          <span class="error-msg"></span>
        </div>
        <div class="form-group" data-field="fvcpred">
          <label>FVC % Predicted <span class="req">*</span></label>
          <input type="number" id="fvcpred" placeholder="e.g., 78" step="0.1" min="0" max="200">
          <span class="desc">Normal: ‚â• 80%</span>
          <span class="error-msg"></span>
        </div>
      </div>
    </div>

    <!-- Clinical Scores -->
    <div class="form-card">
      <div class="section-header">
        <div class="section-icon">üìä</div>
        <h2>Clinical Scores</h2>
      </div>
      <div class="form-grid">
        <div class="form-group" data-field="cat">
          <label>CAT Score (0‚Äì40) <span class="req">*</span></label>
          <input type="number" id="cat" placeholder="e.g., 18" min="0" max="40" step="1">
          <span class="desc">COPD Assessment Test; &lt;10 low, 10‚Äì20 medium, 21‚Äì30 high, &gt;30 very high impact</span>
          <span class="error-msg"></span>
        </div>
        <div class="form-group" data-field="had">
          <label>HAD Score <span class="req">*</span></label>
          <input type="number" id="had" placeholder="e.g., 9" step="0.1" min="0">
          <span class="desc">Hospital Anxiety & Depression; 0‚Äì7 normal, 8‚Äì10 borderline, ‚â•11 abnormal</span>
          <span class="error-msg"></span>
        </div>
        <div class="form-group" data-field="sgrq">
          <label>SGRQ Score (0‚Äì100) <span class="req">*</span></label>
          <input type="number" id="sgrq" placeholder="e.g., 45" step="0.1" min="0" max="100">
          <span class="desc">St George's Respiratory Questionnaire; lower is better, &gt;25 significant</span>
          <span class="error-msg"></span>
        </div>
      </div>
    </div>

    <!-- Comorbidities -->
    <div class="form-card">
      <div class="section-header">
        <div class="section-icon">üè•</div>
        <h2>Comorbidities &amp; Smoking</h2>
      </div>
      <div class="form-grid">
        <div class="form-group" data-field="smoking">
          <label>Current Smoking Status <span class="req">*</span></label>
          <select id="smoking">
            <option value="">Select</option>
            <option value="1">Non-smoker / Ex-smoker</option>
            <option value="2">Current Smoker</option>
          </select>
          <span class="error-msg"></span>
        </div>
        <div class="form-group" data-field="diabetes">
          <label>Diabetes</label>
          <select id="diabetes"><option value="0">No</option><option value="1">Yes</option></select>
        </div>
        <div class="form-group" data-field="muscular">
          <label>Muscular Disease</label>
          <select id="muscular"><option value="0">No</option><option value="1">Yes</option></select>
        </div>
        <div class="form-group" data-field="hypertension">
          <label>Hypertension</label>
          <select id="hypertension"><option value="0">No</option><option value="1">Yes</option></select>
        </div>
        <div class="form-group" data-field="atrial_fib">
          <label>Atrial Fibrillation</label>
          <select id="atrial_fib"><option value="0">No</option><option value="1">Yes</option></select>
        </div>
        <div class="form-group" data-field="ihd">
          <label>Ischaemic Heart Disease</label>
          <select id="ihd"><option value="0">No</option><option value="1">Yes</option></select>
        </div>
      </div>
    </div>

    <!-- Submit -->
    <div class="submit-wrap">
      <button type="submit" class="btn-primary" id="submitBtn">
        Analyze COPD Severity
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
      </button>
    </div>

    <!-- Inline Result Panel -->
    <div id="result-panel" style="display:none; margin-top:1.5rem; animation:fadeUp 0.4s ease">
      <div class="form-card" style="margin-bottom:0">
        <div class="section-header">
          <div class="section-icon">üìã</div>
          <h2>Diagnostic Result</h2>
        </div>

        <!-- Severity badge -->
        <div id="result-box" class="result-badge-box">
          <div class="result-label">COPD Severity Classification</div>
          <div id="result-value" class="result-value">‚Äî</div>
          <div class="conf-wrap">
            <div id="conf-text" class="conf-text"></div>
            <div class="conf-track">
              <div id="conf-fill" class="conf-fill"></div>
            </div>
          </div>
        </div>

        <!-- Submitted values table -->
        <h3 class="sub-heading">Submitted Values</h3>
        <table class="detail-table">
          <thead><tr><th>Parameter</th><th>Value</th><th>Reference / Notes</th></tr></thead>
          <tbody id="detailBody"></tbody>
        </table>

        <!-- Observations -->
        <h3 class="sub-heading">Observations</h3>
        <ul class="obs-list" id="obsList"></ul>

        <!-- Recommendations -->
        <h3 class="sub-heading">Recommendations</h3>
        <ul class="rec-list" id="recList"></ul>

        <!-- Feedback inline -->
        <div id="feedback-section" style="text-align:center;margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border)">
          <div style="font-size:.9rem;color:var(--text-muted);margin-bottom:1rem">
            <strong style="color:var(--text)">Is this diagnosis correct?</strong><br/>
            Your feedback helps improve our model.
          </div>
          <div style="display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap">
            <button id="fbYes"  type="button" onclick="sendFeedback('Yes')"  style="padding:.6rem 1.8rem;border-radius:50px;font-size:.875rem;font-weight:600;cursor:pointer;border:2px solid var(--success);color:var(--success);background:transparent;transition:all .2s">‚úì Yes, Correct</button>
            <button id="fbNo"   type="button" onclick="sendFeedback('No')"   style="padding:.6rem 1.8rem;border-radius:50px;font-size:.875rem;font-weight:600;cursor:pointer;border:2px solid var(--destructive);color:var(--destructive);background:transparent;transition:all .2s">‚úó No, Incorrect</button>
            <button id="fbSkip" type="button" onclick="sendFeedback(null)"   style="padding:.6rem 1.8rem;border-radius:50px;font-size:.875rem;font-weight:600;cursor:pointer;border:2px solid #9ca3af;color:#9ca3af;background:transparent;transition:all .2s">Skip</button>
          </div>
          <div id="feedback-done" style="display:none;font-size:.9rem;color:var(--primary);margin-top:.75rem"></div>
        </div>
      </div>
    </div>

    <!-- Disclaimer -->
    <div class="disclaimer" style="margin-top:1.5rem">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <p>This tool is for educational and screening purposes only and is not a medical diagnosis. Always consult a qualified pulmonologist or healthcare professional for medical advice.</p>
    </div>

  </form>
</div>

<!-- Footer -->
<footer class="footer">
  <p>&copy; 2026 VITALYTICS. For educational purposes only. Not a substitute for professional medical advice.</p>
</footer>

<script>
document.getElementById('menuBtn').addEventListener('click', () => {
  document.getElementById('navLinks').classList.toggle('open');
});

const API = '';   // same-origin; update if backend is on a different host
let lastResult = null;

// ‚îÄ‚îÄ GOLD severity thresholds (FEV1% predicted) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SEV_COLORS = {
  'MILD':        { cls: 'sev-mild',       fill: 'hsl(142,60%,40%)' },
  'MODERATE':    { cls: 'sev-moderate',   fill: 'hsl(38,92%,50%)'  },
  'SEVERE':      { cls: 'sev-severe',     fill: 'hsl(0,72%,51%)'   },
  'VERY SEVERE': { cls: 'sev-very-severe',fill: 'hsl(0,72%,38%)'   },
};

const SEV_MSGS = {
  'MILD':        'Mild COPD. Lifestyle optimisation and annual monitoring recommended.',
  'MODERATE':    'Moderate COPD. Inhaler therapy and pulmonary rehabilitation advised.',
  'SEVERE':      'Severe COPD. Prompt specialist consultation and optimised pharmacotherapy required.',
  'VERY SEVERE': 'Very Severe COPD. Immediate specialist referral and comprehensive management plan needed.',
};

// ‚îÄ‚îÄ Reference ranges (for abnormal flagging & observations) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const REFS = {
  fev1pred: { min: 80,  max: 200, unit: '%', label: 'FEV1 % Predicted' },
  fvcpred:  { min: 80,  max: 200, unit: '%', label: 'FVC % Predicted'  },
  mwt1best: { min: 400, max: 9999,unit: 'm', label: '6-Min Walk Distance' },
  cat:      { min: 0,   max: 9,   unit: '',  label: 'CAT Score'        },
  had:      { min: 0,   max: 7,   unit: '',  label: 'HAD Score'        },
  sgrq:     { min: 0,   max: 25,  unit: '',  label: 'SGRQ Score'       },
};

function isAbnormal(key, value) {
  const ref = REFS[key];
  if (!ref) return false;
  return value < ref.min || value > ref.max;
}

// ‚îÄ‚îÄ Form submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('copdForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!validateForm()) return;

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.innerHTML = 'Analyzing... <div style="display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle"></div>';

  const g = id => document.getElementById(id);
  const payload = {
    age:           g('age').value,
    gender:        g('gender').value,
    pack_history:  g('pack_history').value,
    age_quartiles: g('age_quartiles').value,
    mwt1:          g('mwt1').value,
    mwt2:          g('mwt2').value,
    mwt1best:      g('mwt1best').value,
    fev1:          g('fev1').value,
    fev1pred:      g('fev1pred').value,
    fvc:           g('fvc').value,
    fvcpred:       g('fvcpred').value,
    cat:           g('cat').value,
    had:           g('had').value,
    sgrq:          g('sgrq').value,
    smoking:       g('smoking').value,
    diabetes:      g('diabetes').value,
    muscular:      g('muscular').value,
    hypertension:  g('hypertension').value,
    atrial_fib:    g('atrial_fib').value,
    ihd:           g('ihd').value,
  };

  try {
    const res  = await fetch(`${API}/predict/copd`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    lastResult = data;
    showResult(data, payload);
  } catch (err) {
    alert('Prediction error: ' + err.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Analyze COPD Severity <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>';
  }
});

// ‚îÄ‚îÄ Validation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function validateForm() {
  const required = ['age','gender','pack_history','age_quartiles','mwt1','mwt2','mwt1best',
                    'fev1','fev1pred','fvc','fvcpred','cat','had','sgrq','smoking'];
  let ok = true;
  required.forEach(id => {
    const el  = document.getElementById(id);
    const grp = el.closest('.form-group');
    const msg = grp ? grp.querySelector('.error-msg') : null;
    if (!el.value || el.value === '') {
      if (grp) grp.classList.add('error');
      if (msg) msg.textContent = 'This field is required.';
      ok = false;
    } else {
      if (grp) grp.classList.remove('error');
      if (msg) msg.textContent = '';
    }
  });
  return ok;
}

// ‚îÄ‚îÄ Show result ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showResult(data, payload) {
  const panel    = document.getElementById('result-panel');
  const box      = document.getElementById('result-box');
  const valEl    = document.getElementById('result-value');
  const confText = document.getElementById('conf-text');
  const confFill = document.getElementById('conf-fill');
  const fbDone   = document.getElementById('feedback-done');

  const sev = data.prediction;   // e.g. "MILD" | "MODERATE" | "SEVERE" | "VERY SEVERE"
  const sc  = SEV_COLORS[sev] || { cls: 'sev-severe', fill: 'var(--destructive)' };

  box.className = 'result-badge-box ' + sc.cls;
  valEl.textContent  = sev;
  valEl.style.color  = sc.fill;

  const pct = data.confidence_pct != null ? data.confidence_pct
            : data.confidence      != null ? Math.round(data.confidence * 100) : null;
  confText.textContent = pct != null ? `Model Confidence: ${pct}%` : '';
  confFill.style.background = sc.fill;
  setTimeout(() => confFill.style.width = (pct || 70) + '%', 100);

  buildDetailTable(payload);
  buildObservations(payload, sev);

  ['fbYes','fbNo','fbSkip'].forEach(id => document.getElementById(id).disabled = false);
  fbDone.style.display = 'none';

  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ‚îÄ‚îÄ Detail table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildDetailTable(p) {
  const genderLabel = p.gender === '1' ? 'Male' : 'Female';
  const smokingLabel = p.smoking === '1' ? 'Current Smoker' : 'Non-smoker / Ex-smoker';
  const aqLabel = ['', 'Q1 (youngest)', 'Q2', 'Q3', 'Q4 (oldest)'][parseInt(p.age_quartiles)] || p.age_quartiles;

  const rows = [
    { label: 'Age',                key: null,       val: p.age + ' yrs',            ref: '‚Äî' },
    { label: 'Gender',             key: null,       val: genderLabel,                ref: '‚Äî' },
    { label: 'Pack History',       key: null,       val: p.pack_history + ' pack-years', ref: '‚Äî' },
    { label: 'Age Quartile',       key: null,       val: aqLabel,                    ref: '‚Äî' },
    { label: '6-Min Walk (MWT1Best)', key: 'mwt1best', val: p.mwt1best + ' m',      ref: '‚â• 400 m (normal)' },
    { label: 'FEV1',               key: null,       val: p.fev1 + ' L',              ref: '‚Äî' },
    { label: 'FEV1 % Predicted',   key: 'fev1pred', val: p.fev1pred + ' %',         ref: 'GOLD: ‚â•80% Mild, 50‚Äì79% Mod, 30‚Äì49% Sev, <30% V.Sev' },
    { label: 'FVC',                key: null,       val: p.fvc + ' L',               ref: '‚Äî' },
    { label: 'FVC % Predicted',    key: 'fvcpred',  val: p.fvcpred + ' %',           ref: '‚â• 80%' },
    { label: 'CAT Score',          key: 'cat',      val: p.cat,                      ref: '< 10 (low impact)' },
    { label: 'HAD Score',          key: 'had',      val: p.had,                      ref: '0‚Äì7 (normal)' },
    { label: 'SGRQ Score',         key: 'sgrq',     val: p.sgrq,                     ref: '< 25 (low impairment)' },
    { label: 'Smoking Status',     key: null,       val: smokingLabel,               ref: '‚Äî' },
    { label: 'Diabetes',           key: null,       val: p.diabetes === '1' ? 'Yes' : 'No', ref: '‚Äî' },
    { label: 'Muscular Disease',   key: null,       val: p.muscular === '1' ? 'Yes' : 'No', ref: '‚Äî' },
    { label: 'Hypertension',       key: null,       val: p.hypertension === '1' ? 'Yes' : 'No', ref: '‚Äî' },
    { label: 'Atrial Fibrillation',key: null,       val: p.atrial_fib === '1' ? 'Yes' : 'No', ref: '‚Äî' },
    { label: 'Ischaemic Heart Dis.',key: null,      val: p.ihd === '1' ? 'Yes' : 'No', ref: '‚Äî' },
  ];

  const tbody = document.getElementById('detailBody');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const abn = r.key && isAbnormal(r.key, parseFloat(p[r.key]));
    const tr  = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.label}${abn ? '<span class="flag">‚ö† ABNORMAL</span>' : ''}</td>
      <td style="color:${abn ? 'var(--destructive)' : 'inherit'}">${r.val}</td>
      <td style="color:var(--text-muted);font-weight:400">${r.ref}</td>`;
    tbody.appendChild(tr);
  });
}

// ‚îÄ‚îÄ Observations & Recommendations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildObservations(p, sev) {
  const obsList = document.getElementById('obsList');
  const recList = document.getElementById('recList');
  obsList.innerHTML = '';
  recList.innerHTML = '';

  const fev1p   = parseFloat(p.fev1pred);
  const fvcp    = parseFloat(p.fvcpred);
  const cat     = parseFloat(p.cat);
  const had     = parseFloat(p.had);
  const sgrq    = parseFloat(p.sgrq);
  const walk    = parseFloat(p.mwt1best);
  const smoking = p.smoking === '1';

  // Observations
  if (fev1p < 30)       addItem(obsList, `FEV1 % Predicted is critically low (${fev1p}%) ‚Äî consistent with Very Severe airflow obstruction (GOLD Grade 4).`);
  else if (fev1p < 50)  addItem(obsList, `FEV1 % Predicted is severely reduced (${fev1p}%) ‚Äî consistent with Severe airflow obstruction (GOLD Grade 3).`);
  else if (fev1p < 80)  addItem(obsList, `FEV1 % Predicted is moderately reduced (${fev1p}%) ‚Äî consistent with Moderate airflow obstruction (GOLD Grade 2).`);

  if (fvcp < 80)        addItem(obsList, `FVC % Predicted is below normal (${fvcp}%), indicating reduced lung volume.`);
  if (walk < 400)       addItem(obsList, `6-Minute Walk Distance (${walk} m) is below the normal threshold of 400 m, suggesting functional impairment.`);
  if (cat >= 21)        addItem(obsList, `CAT Score (${cat}) indicates high-to-very-high symptom burden ‚Äî significant impact on quality of life.`);
  else if (cat >= 10)   addItem(obsList, `CAT Score (${cat}) reflects medium symptom impact on daily activities.`);
  if (had > 10)         addItem(obsList, `HAD Score (${had}) is in the abnormal range (‚â•11), suggesting significant anxiety or depression.`);
  else if (had > 7)     addItem(obsList, `HAD Score (${had}) is in the borderline range (8‚Äì10) for anxiety/depression.`);
  if (sgrq > 25)        addItem(obsList, `SGRQ Score (${sgrq}) is above the clinically significant threshold of 25, indicating meaningful health-status impairment.`);
  if (smoking)          addItem(obsList, 'Patient is a current smoker ‚Äî smoking cessation is the single most effective intervention to slow disease progression.');
  if (p.diabetes === '1') addItem(obsList, 'Diabetes is present; glycaemic control affects respiratory muscle function and may worsen COPD outcomes.');
  if (p.ihd === '1' || p.atrial_fib === '1') addItem(obsList, 'Cardiac comorbidity (IHD / AF) noted; cardiovascular risk requires coordinated management with COPD.');

  if (obsList.children.length === 0) addItem(obsList, 'Clinical scores are within acceptable ranges. Continue monitoring as per clinical schedule.');

  // Recommendations
  const isModPlus = ['MODERATE','SEVERE','VERY SEVERE'].includes(sev);
  const isSevPlus = ['SEVERE','VERY SEVERE'].includes(sev);

  if (smoking) addItem(recList, 'Prioritise smoking cessation immediately ‚Äî enrol in a cessation programme or NRT/pharmacotherapy.');
  addItem(recList, 'Refer to a pulmonologist for a full spirometric evaluation and GOLD stage confirmation.');
  if (isModPlus) {
    addItem(recList, 'Initiate or review bronchodilator therapy (LABA, LAMA, or combination) according to GOLD guidelines.');
    addItem(recList, 'Enrol in a supervised Pulmonary Rehabilitation Programme to improve exercise tolerance and quality of life.');
  }
  if (isSevPlus) {
    addItem(recList, 'Assess need for Long-Term Oxygen Therapy (LTOT) if resting SpO‚ÇÇ < 88%.');
    addItem(recList, 'Evaluate for inhaled corticosteroid add-on therapy if frequent exacerbations occur.');
  }
  if (sgrq > 25 || cat >= 10) addItem(recList, 'Provide access to psychological support or CBT if HAD or SGRQ scores indicate anxiety/depression.');
  addItem(recList, 'Ensure up-to-date influenza and pneumococcal vaccinations to reduce exacerbation risk.');
  addItem(recList, 'Develop a personalised action plan for exacerbation recognition and early self-management.');
  if (!isModPlus) addItem(recList, 'Annual spirometry monitoring and lifestyle counselling (exercise, diet, weight management) are recommended.');
}

function addItem(ul, text) {
  const li = document.createElement('li');
  li.textContent = text;
  ul.appendChild(li);
}

// ‚îÄ‚îÄ Feedback ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendFeedback(val) {
  ['fbYes','fbNo','fbSkip'].forEach(id => document.getElementById(id).disabled = true);
  const done = document.getElementById('feedback-done');

  if (val === null) {
    done.textContent = 'Response saved without feedback.';
    done.style.display = 'block';
    return;
  }
  if (!lastResult) return;
  try {
    await fetch(`${API}/feedback`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: lastResult.id, tab: lastResult.tab, feedback: val })
    });
  } catch(e) { console.warn('Feedback error', e); }
  done.textContent = '‚úì Thank you for your feedback!';
  done.style.display = 'block';
}
</script>
</body>
</html>
